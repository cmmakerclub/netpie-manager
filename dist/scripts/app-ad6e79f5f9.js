function DevicesCtrl(e,n,t,i,a,o,d,c,r,l){function s(e,n,t,i){e.devices=i,e.deviceUUID=t,e.hide=function(e){n.hide(e)},e.cancel=function(){n.cancel()}}s.$inject=["$scope","$mdDialog","deviceUUID","devices"];var m=this,u=r;e.devices={},m.LWT={};var p,g=function(e){var n=d.debounce(function(){o(e).toggle().then(function(){r.debug("toggle "+e+" is done")})},200);return n};e.toggleRight=g("right");var v={devices:{config:{prefix:"/ChiangMaiMakerClub",topic_sub:"/ChiangMaiMakerClub",host:"iot.eclipse.org",myName:"",port:80},checkbox:{clientId:!0,userPass:!1},devices:[]}};i.$default(v),e.config=i.devices.config,e.checkbox=i.devices.checkbox||{},e.$watch("checkbox.clientId",function(n,t){e.config.clientId=n===!0?guid("cmmc"):""}),e.closeNav=function(){o("right").close().then(function(){e.config=angular.extend({},e.config)})},e.closeAndSaveNewConfig=function(n){o("right").close().then(function(){console.log("NEW CONFIG",n),e.config=n,l.location.reload()})},e.onlineStatus="ALL",e.filterDevice={},e.filterDevice.name="";var b=function(n,t){var i=n.split("/"),a=i[i.length-1];if("online"==a){console.log("online",i);var o=t.split("|"),d=o[0],c=o[1],l=o[1];r.debug("id",c,"mac",l,"status",d,new Date),l&&l===d&&(d="online"),m.LWT[l||c]=d,e.devices[l||c]&&(e.devices[l||c].status=d,console.log(m),e.$apply())}else{var s=JSON.parse(t),u=s.info&&s.info.id;console.log("TOPIC",i,"PAYLOAD",t);var p=s.d&&s.d.id;s.status=m.LWT[p||u]||"ONLINE"||"UNKNOWN",s.online="DEAD"!==s.status,e.devices[p||u]=s,delete e.devices.undefined,e.$apply()}};e.showDetail=function(n,t){c.show({controller:s,templateUrl:"app/devices/partials/detail.html",parent:angular.element(document.body),targetEvent:n,clickOutsideToClose:!0,locals:{deviceUUID:t,devices:e.allDevices}}).then(function(){},function(){r.info("You cancelled the dialog.")})};e.allDevices=function(){return e.devices},e.connect=function(){e.status="Connecting ... ",e.status+=e.config.topic_sub,r.debug("CHECKBOX",e.checkbox),e.checkbox.userPass===!1?(delete e.config.username,delete e.config.password):r.debug("userPass",e.config),e.devices={},t.on("message",b);var n=function(n){var t=function(t){e.failed=!0,r.error(n+" FAILED",t),e.status=n+" FAILED = "+t.errorMessage};return t},i={SUBSCRIPTION:{failFn:n("SUBSCRIPTION")},CONNECTION:{failFn:n("CONNECTION")}};u.debug("debug",e.config),t.create(e.config).then(function(e){p=e}).then(t.connect,i.CONNECTION.failFn).then(t.subscribe(e.config.topic_sub),i.SUBSCRIPTION.failFn).then(function(n){angular.isUndefined(n)||(e.status="READY ",e.status+="TOPIC = ",e.status+=e.config.topic_sub)})},e.connect(),e.disconnect=function(){}}DevicesCtrl.$inject=["$scope","$timeout","myMqtt","$localStorage","$sessionStorage","$mdSidenav","$mdUtil","$mdDialog","$log","$window"],function(){"use strict";angular.module("netpieManager",["ngAnimate","ngCookies","ngSanitize","ngResource","ja.qr","ui.router","ngMaterial","ngStorage"])}();var STORAGE_KEY="netpie_manager";angular.module("netpieManager").controller("netpieCtrl",["$timeout","toastr","$http","$log","$window","$mdSidenav","$localStorage","$scope",function(e,n,t,i,a,o,d,c){var r=this;r.generate=function(){var e="https://netpie-api.herokuapp.com/api/";e+=c.config.netpie.appKey+"/",e+=c.config.netpie.appSecret+"/",e+=c.config.netpie.appId,e+="?callback=JSON_CALLBACK",c.loading=!0,t.jsonp(e).success(function(e){var n=c.config.netpie.appId;delete e.protocolVersion,delete e.keepalive,e.appId=c.config.netpie.appId,e.appKey=c.config.netpie.appKey,e.appSecret=c.config.netpie.appSecret,e.myName=c.config.netpie.myName,e.prefix="/"+n+"/gearname",s.latest_device=e;var t=s.devices||[];t.push(e),i.debug(t),s.devices=t,c.device_count=t.length,c.latest_device=s.latest_device,c.loading=!1,c.failed=!1}).error(function(){i.debug("FAILED"),s.latest_device={},c.loading=!1,c.failed=!0,c.appError="Failed: "+arguments[1]+" "+arguments[0]})},r.clear=function(){i.debug("Wipe the data. Reloading.."),d.$reset({}),a.location.reload()};var l=d.$default({netpie_manager:{netpie:{}},netpieApp:[]}),s=l[STORAGE_KEY];c.config=s.netpie,c.latest_device=s.latest_device,c.device_count=s.devices&&s.devices.length||0,c.tabs=s.devices||[],c.selectedIndex=c.tabs.length-1,c.openMenu=function(){e(function(){o("left").open()})};var m=document.querySelector("[role='main']");c.focusMainContent=function(n){n&&n.preventDefault(),e(function(){m.focus()},90)},c.loadDevices=function(){return c.devices=s.devices,s.devices}}]),angular.module("netpieManager").filter("status",function(){return function(e,n){if("ALL"==n)return e;var t={};return angular.forEach(e,function(e,i){e.status==n&&(t[i]=e)}),t}}).filter("name",function(){return function(e,n){var t={};return angular.forEach(e,function(e,i){e.d.myName.toLowerCase().indexOf(n.toLowerCase())>-1&&(t[i]=e)}),t}}).filter("isEmpty",function(){var e;return function(n){for(e in n)if(n.hasOwnProperty(e))return!1;return!0}}),angular.module("netpieManager").directive("sidebarMqttConfig",function(){return{templateUrl:"app/devices/partials/sidebar.html",restrict:"E",link:function(e,n,t){}}}),String.prototype.isEmpty=function(){return 0===this.length||!this.trim()};var guid=function(e){function n(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return n()+"-"+(new Date).getTime()};angular.module("netpieManager").factory("myMqtt",["mqttwsProvider",function(e){var n=e({});return console.log(n),n}]).controller("devicesCtrl",DevicesCtrl),function(){"use strict";function e(){function e(e){var n=this;n.relativeDate=e(n.creationDate).fromNow()}e.$inject=["moment"];var n={restrict:"E",templateUrl:"app/components/navbar/navbar.html",scope:{creationDate:"="},controller:e,controllerAs:"vm",bindToController:!0};return n}angular.module("netpieManager").directive("acmeNavbar",e)}(),angular.module("netpieManager").provider("mqttwsProvider",function(){this.$get=["$q","$window","$log",function(e,n,t){var i=function(e){var n=new Date;return e+"."+n.getTime()};return function(n){var a,o,d,c=!1,r=!0,l={},s={},m={on:function(e,n){l[e]=n},addListener:function(e,n){l[e]=n},subscribe:function(n,i){var a=function(){t.info("SUBSCRIBING...",arguments),i=i||{qos:0};var a=e.defer();return i.onSuccess=function(){t.debug("PROVIDER","subscribe succeeded."),a.resolve(d)},d.connected?t.info("info","client connected"):t.info("info","NOT client connected"),d.subscribe(n,i),t.debug("PROVIDER","SUB",n,i),a.promise};return a},create:function(n){var c=e.defer();return n=angular.extend(s,n),a=n.host,o=parseInt(n.port,10),t.info("CREATE WITH CONFIG",n),n.clientId||(t.debug("not providing clientId"),t.debug("PROVIDER"," clientId = ",n.clientId),n.clientId=i("RANDOM")),d=new Paho.MQTT.Client(a,o,n.clientId),c.resolve(d),c.promise},connect:function(){var n=e.defer(),i=function(){var e=l.connected||function(){};t.debug("PROVIDER","CONNECTION CONNECTED"),e.call(null,arguments),n.resolve(arguments)},a=function(e){t.error("ON FAILURE",e),n.reject(e)},o={timeout:3,useSSL:c,mqttVersion:3,cleanSession:r,onSuccess:i,onFailure:a};return t.debug("PROVIDER WITH ","OPTIONS",s),s.username&&(o.userName=s.username,o.password=s.password),d.connect(o),d.onMessageArrived=function(e){var n=e.destinationName,t=e.payloadString,i=l.message||function(){};i.apply(null,[n,t,e]);var a=l[n.toString()]||function(){};a.apply(null,[t,e])},n.promise}};return m}}]}),function(){"use strict";function e(e,t,i,a,o,d,c,r){var l={main:{config:{prefix:"/ChiangMaiMakerClub",host:"iot.eclipse.org",myName:"",port:1883},checkbox:{clientId:!0,userPass:!1},devices:[]}};c.$default(l),r.config=c.main.config,r.tab=r.config||{},r.checkbox=c.main.checkbox||{},r.$watch("checkbox.clientId",function(e,t){r.config.clientId=e===!0?n("cmmc"):""}),r.tabs=c.main.devices||[],r.device_count=r.tabs.length,r.selectedIndex=r.tabs.length,this.generate=function(){if(a.debug("generate"),r.config.myName.isEmpty())a.error("EMPTY myName");else{r.checkbox.userPass||(r.config.password="",r.config.username="");var e=angular.copy(r.config);c.main.devices.push(e),console.log(c.main.devices),r.config.clientId=n("cmmc"),r.config.myName="",r.tabs=c.main.devices}},r.loadDevices=function(){return r.devices=c.main.devices,c.main.devices},this.clear=function(){a.debug("generate"),c.main.devices=[],r.config.clientId=n("cmmc"),r.tabs=c.main.devices}}e.$inject=["$timeout","toastr","$http","$log","$window","$mdSidenav","$localStorage","$scope"],String.prototype.isEmpty=function(){return 0===this.length||!this.trim()};var n=function(e){function n(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return n()+"-"+(new Date).getTime()};angular.module("netpieManager").controller("MainController",e)}(),function(){"use strict";function e(e){e.debug("runBlock end")}e.$inject=["$log"],angular.module("netpieManager").run(e)}(),function(){"use strict";function e(e,n){e.state("home",{url:"/",templateUrl:"app/main/main.html",controller:"MainController",controllerAs:"main"}).state("netpie",{url:"/netpie",templateUrl:"app/netpie/partials/netpie.html",controller:"netpieCtrl",controllerAs:"netpieCtrl"}).state("devices",{url:"/devices",templateUrl:"app/devices/partials/devices.html",controller:"devicesCtrl",controllerAs:"devicesCtrl"}),n.otherwise("/")}e.$inject=["$stateProvider","$urlRouterProvider"],angular.module("netpieManager").config(e)}(),function(){"use strict";angular.module("netpieManager").constant("toastr",toastr).constant("moment",moment)}(),function(){"use strict";function e(e,n){e.debugEnabled(!0),n.options.timeOut=3e3,n.options.positionClass="toast-top-right",n.options.preventDuplicates=!0,n.options.progressBar=!0}e.$inject=["$logProvider","toastr"],angular.module("netpieManager").config(e)}(),angular.module("netpieManager").run(["$templateCache",function(e){e.put("app/main/main.html",'<div layout=column layout-sm=column><md-content><header><acme-navbar creationdate=main.creationDate></acme-navbar></header></md-content><md-content layout=row layout-sm=column><md-content flex md-dynamic-height><md-card><md-toolbar layout-align="center center">Detail ({{device_count}})</md-toolbar><md-progress-circular md-mode=indeterminate ng-show=loading></md-progress-circular><md-content><md-tabs md-selected=selectedIndex md-border-bottom md-autoselect md-dynamic-height><md-tab ng-repeat="tab in tabs" ng-disabled=tab.disabled label={{tab.myName}}-{{tab.clientId}}><div class="demo-tab tab{{$index%4}}" style="padding: 25px; text-align: left;"><md-card-content layout=column md-dynamic-height ng-hide=loading ng-show=!failed><md-list class=a aria-expanded=false><md-content layout=column><md-content layout=column><div>#define MQTT_HOST "{{tab.host}}"</div><div>#define MQTT_PORT "{{tab.port}}"</div><div>#define PUBLISH_EVERY 3000 // 5secs</div><div><br></div><div>#define MQTT_USERNAME "{{tab.username}}"</div><div>#define MQTT_PASSWORD "{{tab.password}}"</div><div>#define MQTT_CLIENT_ID "{{tab.clientId}}"</div><div>#define MQTT_PREFIX "{{tab.prefix}}"</div><div><div>mosquitto_sub -i "{{tab.clientId}} -u "{{tab.username}} -P "{{tab.password}}" -h "{{tab.host}} -t "{{tab.prefix}}"</div><div><br></div><div>/* SENSOR INFO */</div><div>#define DEVICE_NAME "{{tab.myName}}"</div><div><br></div><div></div></div></md-content><md-divider></md-divider><md-subheader class=md-no-sticky>QR CODE</md-subheader><md-content ng-hide=showQRFlag layout=column layout-align="center center"><qr text="tab | json"></qr></md-content></md-content></md-list></md-card-content></div><div layout=column style="height: 100px;"><md-select placeholder="Who you want to hear?" ng-model=tab.target_device ng-change md-on-open=loadDevices() style="min-width: 200px;"><md-option ng-value=device.clientId ng-repeat="device in devices">{{ device.myName}} - {{device.clientId}}</md-option></md-select><div></div></div></md-tab></md-tabs></md-content><br></md-card></md-content></md-content></div><h1>{{ appError }}</h1><md-content flex><md-card><section><md-content class="md-content-right md-whiteframe-z2" md-component-id=right layout-align="start center"><md-toolbar class=md-theme-light layout=row layout-align="center center">Config</md-toolbar><md-content layout-padding class=autoScroll><form ng-submit=closeAndSaveNewConfig(config)><md-input-container><label>myName - DEVICE_NAME</label> <input ng-model=config.myName required></md-input-container><md-input-container><label>Host</label> <input ng-model=config.host required></md-input-container><md-input-container><label>Port</label> <input ng-model=config.port required></md-input-container><md-input-container ng-show=checkbox.userPass><label>Username</label> <input ng-model=config.username></md-input-container><md-input-container ng-show=checkbox.userPass><label>Password</label> <input ng-model=config.password type=password></md-input-container><md-input-container><label>clientId</label> <input ng-model=config.clientId required></md-input-container><md-input-container><label>prefix</label> <input ng-model=config.prefix required></md-input-container><md-checkbox ng-change ng-model=checkbox.clientId aria-label="Checkbox 2" class="md-warn md-align-top-left">autogen clientId</md-checkbox><md-checkbox ng-model=checkbox.userPass aria-label="Checkbox 2" class="md-warn md-align-top-left">username & password</md-checkbox><md-input-container><md-button ng-click=main.generate() class=md-raised>Save</md-button></md-input-container></form><md-input-container><md-button class="md-raised md-warn" ng-click=main.clear()>Clear All</md-button></md-input-container></md-content></md-content></section></md-card></md-content>'),e.put("app/components/navbar/navbar.html",'<md-toolbar layout=row layout-align="center center"><section flex layout=row layout-align="left center"><md-button href=https://cmmakerclub.com>CMMAKERCLUB.COM</md-button><md-button href="#/" class=md-raised>MQTT Generator</md-button><md-button href=#/netpie class=md-raised>Netpie Generator</md-button><md-button href=#/devices class=md-raised>CMMC Devices</md-button></section><md-button class=acme-navbar-text>CMMC AUTH MANAGER</md-button></md-toolbar>'),e.put("app/devices/partials/adevices.html","<div layout=column layout-sm=column><md-content><header><acme-navbar creationdate=main.creationDate></acme-navbar></header></md-content></div>"),e.put("app/devices/partials/detail.html",'<md-dialog flex=60><md-toolbar><div class=md-toolbar-tools><h2>{{ devices()[deviceUUID].d.myName }}</h2><span flex></span></div></md-toolbar><md-dialog-content md-dynamic-height><md-list class=a><md-subheader class=md-no-sticky>DATA</md-subheader><md-list-item class=md-2-line ng-repeat="(key, value) in devices()[deviceUUID].d"><img ng-src={{item.face}}?{{$index}} class=md-avatar alt={{item.who}}><div class=md-list-item-text layout=column><h3>{{ key }}</h3><p>{{ value }}</p></div></md-list-item></md-list><md-divider></md-divider><md-list class=b><md-subheader class=md-no-sticky>INFO</md-subheader><md-list-item class=md-2-line ng-repeat="(key, value) in devices()[deviceUUID].info"><md-icon md-svg-icon=communication:phone ng-if="$index === 0"></md-icon><div class=md-list-item-text ng-class="{\'md-offset\': $index != 0 }"><h3>{{ key }}</h3><p>{{ value }}</p></div></md-list-item></md-list></md-dialog-content></md-dialog>'),e.put("app/devices/partials/devices.html",'<div layout=column class=nat-devices><md-content class=devices-wrapper><header><acme-navbar creationdate=main.creationDate></acme-navbar></header><section class=jumbotron><div layout=row layout-align="end center"><md-input-container><label>Filter by name</label> <input ng-model=filterDevice.name></md-input-container><md-input-container><label>Status</label><md-select name=onlineStatus ng-model=onlineStatus required><md-optgroup label=Status><md-option value=ALL>All</md-option><md-option value=ONLINE>Online</md-option><md-option value=DEAD>Offline</md-option></md-optgroup></md-select></md-input-container><md-button ng-click=toggleRight() class=md-primary>Config</md-button><sidebar-mqtt-config></sidebar-mqtt-config></div>{{ status }}<div class=techs layout-align=center><md-card ng-class=device.status ng-repeat="(key, device) in devices | name:filterDevice.name | status:onlineStatus | orderBy:\'status\'"><div class=thumbnail><div class=caption><h3>{{ device.d.myName }} - {{ device.status }}</h3><div ng-show="{{ device.info.id !=\'\' || device.d.id != \'\'}}">{{ device.info.id || device.d.id }}</div><div>{{ device.d.ip }}</div><div>{{ device.d.seconds }} ({{ device.d.subscription }})</div><div>{{ device.info.sensor || device.d.sensor || "?" }}</div><div ng-show={{device.online}}>{{ device.info.id || device.d.id }}/status</div></div></div><div class=md-actions layout=row layout-align="end center"><md-button ng-click="showDetail($event, key)">Detail</md-button></div></md-card></div></section><div ng-init=showFirstPopup($event)></div></md-content></div>'),e.put("app/devices/partials/firstPopup.html",'<md-dialog flex=60><md-toolbar><div class=md-toolbar-tools><h2>Hello Gear</h2><span flex></span></div></md-toolbar><md-dialog-content md-dynamic-height><form name=newConfig ng-submit=save(config)><md-input-container><label>Host</label> <input ng-model=config.host required></md-input-container><md-input-container><label>Port</label> <input ng-model=config.port required></md-input-container><md-input-container><label>clientId</label> <input ng-model=config.clientId required type=clientId></md-input-container><md-input-container ng-show=data.cb_auth><label>Username</label> <input ng-model=config.username></md-input-container><md-input-container ng-show=data.cb_auth><label>Password</label> <input ng-model=config.password type=password></md-input-container><md-checkbox ng-init="data.ssl=false" ng-model=data.ssl aria-label=SSL class="md-warn md-align-top-left"><md-checkbox ng-init="data.cb_auth=false" ng-model=data.cb_auth aria-label="Checkbox 2" class="md-warn md-align-top-left">username & password</md-checkbox><md-input-container><md-button class="md-raised md-primary">Save</md-button></md-input-container></md-checkbox></form></md-dialog-content></md-dialog>'),e.put("app/devices/partials/sidebar.html",'<section><md-sidenav class="md-sidenav-right md-whiteframe-z2" md-component-id=right layout-align="start center"><md-toolbar class=md-theme-light layout=row layout-align="center center">Config</md-toolbar><md-content layout-padding class=autoScroll><form ng-submit=closeAndSaveNewConfig(config)><md-input-container><label>Host</label> <input ng-model=config.host required></md-input-container><md-input-container><label>Port</label> <input ng-model=config.port required></md-input-container><md-input-container ng-show=checkbox.userPass><label>Username</label> <input ng-model=config.username></md-input-container><md-input-container ng-show=checkbox.userPass><label>Password</label> <input ng-model=config.password type=password></md-input-container><md-input-container><label>clientId</label> <input ng-model=config.clientId required></md-input-container><md-input-container><label>subscribe to</label> <input ng-model=config.topic_sub required></md-input-container><md-checkbox ng-model=checkbox.userPass aria-label="Checkbox 2" class="md-warn md-align-top-left">username & password</md-checkbox><md-input-container><md-button ng-click=main.generate() class=md-raised>Save</md-button></md-input-container></form></md-content></md-sidenav></section>'),e.put("app/netpie/partials/netpie.html",'<div layout=column layout-sm=column><md-content><header><acme-navbar creationdate=main.creationDate></acme-navbar></header></md-content><md-content layout=row layout-sm=column><md-content flex md-dynamic-height><md-card><md-toolbar layout-align="center center">Detail ({{device_count}})</md-toolbar><md-progress-circular md-mode=indeterminate ng-show=loading></md-progress-circular><md-content class=md-padding><md-tabs md-selected=selectedIndex md-border-bottom md-autoselect md-dynamic-height><md-tab ng-repeat="tab in tabs" ng-disabled=tab.disabled label={{tab.myName}}-{{tab.clientId}}><div class="demo-tab tab{{$index%4}}" style="padding: 25px; text-align: left;"><md-card-content layout=column md-dynamic-height ng-hide=loading ng-show=!failed><md-list class=a aria-expanded=false><md-content layout=column><md-content layout=column><div>#define MQTT_HOST "gb.netpie.io"</div><div>#define MQTT_USERNAME "{{tab.username}}"</div><div>#define MQTT_PASSWORD "{{tab.password}}"</div><div>#define MQTT_CLIENT_ID "{{tab.clientId}}"</div><div>#define MQTT_PREFIX "{{tab.prefix}}"</div><div></div><div><br></div><div>/* SENSOR INFO */</div><div>#define DEVICE_NAME "{{tab.myName}}"</div><div></div></md-content><md-content layout=column layout-align="center center" layout-padding class- "md-padding"><qr text="tab | json"></qr><div>mosquitto_sub -i "{{tab.clientId}}" -u "{{tab.username}}" -P "{{tab.password}}" -h "gb.netpie.io" -t "{{tab.prefix}}"</div></md-content></md-content></md-list></md-card-content></div><div layout=column style="height: 100px;"><md-select placeholder="Who you want to hear?" ng-model=tab.target_device ng-change md-on-open=loadDevices() style="min-width: 200px;"><md-option ng-value=device.clientId ng-repeat="device in devices">{{ device.myName }} - {{device.clientId}}</md-option></md-select><div></div></div></md-tab></md-tabs></md-content><br></md-card></md-content></md-content></div><h1>{{ appError }}</h1><md-content flex><md-card><md-toolbar layout-align="center center">NETPIE</md-toolbar><md-card-content><md-input-container><label>myName</label> <input ng-model=config.netpie.myName required></md-input-container><md-input-container><label>appKey</label> <input ng-model=config.netpie.appKey></md-input-container><md-input-container><label>appSecret</label> <input ng-model=config.netpie.appSecret></md-input-container><md-input-container><label>appId</label> <input ng-model=config.netpie.appId></md-input-container><md-input-container><md-button class="md-raised md-hue-5" ng-click=netpieCtrl.generate()>Generate</md-button></md-input-container><md-input-container><md-button class="md-raised md-warn" ng-click=netpieCtrl.clear()>Clear</md-button></md-input-container></md-card-content></md-card></md-content>')}]);